#!/usr/bin/env narwhal

(function (evalGlobal) {

var args = system.args;
var print = system.print;

function main() {
    
    var File = require("file").File;
    
    var env = "development",
        options = { port : 8080, host : "0.0.0.0" },
        server = null,
        config = null,
        configFile = null,
        paths = require.loader.getPaths(),
        extensions = require.loader.getExtensions(),
        preload = [];

    while (args.length) {
        var arg = args.shift();
        switch (arg) {
            case "-e" :
            case "--eval" :
                configFile = args.shift();
                break;
            case "-I" :
            case "--include" :
                paths.unshift.apply(paths, args.shift().split(":"));
                break;
            case "-d" :
            case "--debug" :
                $DEBUG = true;
                break;
            case "-w" :
            case "--warn" :
                $WARN = true;
                break;
            case "-s" :
            case "--server" :
                server = args.shift();
                break;
            case "-o" :
            case "--host" :
                options.host = args.shift();
                break;
            case "-p" :
            case "--port" :
                options.port = parseInt(args.shift());
                break;
            case "-E" :
            case "--env" :
                env = args.shift();
                break;
            case "-r" :
            case "--require" :
                preload.push.apply(preload, args.shift());
                break;
            case "-h" :
            case "--help" :
                printUsage();
            case "--version" :
                throw new Error("Jack 0.1");
            default :
                if (config || arg.charAt(0) === "-")
                    printUsage();
                else
                    config = arg;
        }
    }

    if (!configFile) {
        config = config || "config.ju"

        var configFile = String(File.read(config));
        if (!configFile)
            throw new Error("configuration " + config + " not found");
    }

    /*
    try {
        // arrange for modules to be loaded in a sandbox
        // that reloads modules.  replace the global require function so that 
        // its available inside eval for the config file
        var sandboxing = require('chiron/sandbox');
        require = sandboxing.Sandbox({
            environment: require.environment,
            loader: sandboxing.FileLoader({
                paths: paths,
                extensions: extensions,
                debug: $DEBUG
            })
        });
    } catch (exception) {
        // everything will still work when
        // chiron is not installed.
        require.loader.setPaths(paths);
        require.loader.setExtensions(extensions);
    }
    */

    /* preload modules noted by --require options */
    for (var i = 0; i < preload.length; i++)
        require(preload[i], configFile);

    var innerApp = evalGlobal(configFile),
        app;

    switch (env) {
        case "development" :
            app = require("jack/commonlogger").CommonLogger(
                    require("jack/showexceptions").ShowExceptions(
                        require("jack/lint").Lint(innerApp)));
            break;
        case "deployment" :
            app = require("jack/commonlogger").CommonLogger(innerApp);
            break;
        case "none" :
            app = innerApp;
            break;
        default :
            throw new Error("Unknown environment");
    }

    // Load the required handler.
    handler = require("jack/handler/" + (server || "simple")).Handler;
    
    handler.run(app, options);
}

function printUsage() {
    throw new Error("Usage: jackup [jack options] [jackup config]\n\
\n\
    Jack options:\n\
      -s, --server SERVER      serve using SERVER (jetty/simple)\n\
      -o, --host HOST          listen on HOST (default: 0.0.0.0)\n\
      -p, --port PORT          use PORT (default: 9292)\n\
      -E, --env ENVIRONMENT    use ENVIRONMENT for defaults (default: development)\n\
\n\
      -e, --eval LINE          evaluate a LINE of code\n\
      -d, --debug              set debugging flags (set $DEBUG to true)\n\
      -w, --warn               turn warnings on for your script\n\
      -I, --include PATH       specify $LOAD_PATH (may be used more than once)\n\
      -r, --require LIBRARY    require the library, before executing your script\n\
\n\
    Common options:\n\
      -h, --help               Show this message\n\
          --version            Show version");
}

try {
    main();
} catch (e) {
    print(e.message);
}


/* return evalGlobal from global context */
})(function () {
    return eval(arguments[0]);
});

